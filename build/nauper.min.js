"use strict";var Nauper={version:"0.1"};
"use strict";var getTextHeight=function(t){var e=document.createElement("p"),n=0;return e.style.font=t,e.style.position="relative",e.style.zIndex="-1",e.innerHTML="Test",document.body.appendChild(e),n=e.offsetHeight,document.body.removeChild(e),n},wrapText=function(t,e,n,i){var u=e.split(" "),r="",o=getTextHeight(n),c=0,d=[];return u.forEach(function(e,n){c=""===r?t.measureText(e).width:t.measureText(r+" "+e).width,c>i?(d.push(r),r=e):c===i?(d.push(r+" "+e),r=""):c<i&&(r=r?r+" "+e:e,n+1===u.length&&d.push(r))}),{result:d,height:o}},getTextOffset=function(t,e,n){var i=t.measureText(n).width,u=.5*e.width,r=.5*i,o=u-r;return o},putDefaults=function(t,e){var n=Object.getOwnPropertyNames(t),i={};return n.forEach(function(n){void 0===e[n]?i[n]=t[n]:void 0!==e[n]&&(i[n]=e[n])}),i},copyObject=function(t){var e={};return e=putDefaults(t,{})},getWindowSize=function(){return{width:document.documentElement.clientWidth,height:document.documentElement.clientHeight}};
"use strict";Nauper.UI=function(e){this.engine=e,this.canvas=this.engine.canvas,this.render=this.engine.render,this.size=this.engine.size,this.menu=[],this.menuStyle={},this.currentMS=0,this.lastActive=void 0,this.menuOpened=!1,this.menuIconStyle={}},Nauper.UI.prototype.setBackground=function(e){e&&(this.canvas.style.backgroundImage="url(./data/images/backgrounds/"+e+")")},Nauper.UI.prototype.drawTextBox=function(e){var t=this,i={type:"default",color:"#fff",link:"",x:.025,y:.8,height:.18,width:.95,radius:.05,callback:function(){}},n=putDefaults(i,e),h=this.size.width*n.x,r=this.size.height*n.y,s=this.size.height*n.height,a=this.size.width*n.width,l=this.size.height*n.radius;this.render.fillStyle=n.color,"default"===n.type?this.render.fillRect(h,r,a,s):"rounded"===n.type?(this.render.beginPath(),this.render.moveTo(h,r+l),this.render.lineTo(h,r+s-l),this.render.quadraticCurveTo(h,r+s,h+l,r+s),this.render.lineTo(h+a-l,r+s),this.render.quadraticCurveTo(h+a,r+s,h+a,r+s-l),this.render.lineTo(h+a,r+l),this.render.quadraticCurveTo(h+a,r,h+a-l,r),this.render.lineTo(h+l,r),this.render.quadraticCurveTo(h,r,h,r+l),this.render.fill()):"image"===n.type&&!function(){var e=new Image;e.addEventListener("load",function(i){t.render.drawImage(e,h,r,a,s),n.callback&&n.callback(i)}),e.src=n.link}(),"image"!==n.type&&n.callback()},Nauper.UI.prototype.drawText=function(e){var t=this,i={text:"",align:"wrapped",color:"#000",x:.1,y:.85,width:.8},n=putDefaults(i,e),h=this.size.width*n.x,r=this.size.height*n.y,s=this.size.width*n.width;if(this.render.fillStyle=n.color,"wrapped"===n.align)!function(){var e=wrapText(t.render,n.text,t.render.font,s);e.result.forEach(function(i,n){t.render.fillText(i,h,r+e.height*n)})}();else if("center"===n.align){var a=getTextOffset(this.render,{width:this.canvas.width},n.text);this.render.fillText(n.text,a,r)}},Nauper.UI.prototype.process=function(e){var t=void 0,i=this.engine.elements[0][0];if(i!==this.engine.element||this.engine.firstPassed)if(this.menuOpened){for(var n=0;n<this.menu[this.currentMS].length;n+=1){var h=this.menu[this.currentMS][n];if(e.pageX>=h.x&&e.pageX<=h.x+h.width&&e.pageY>=h.y&&e.pageY<=h.y+h.height){h.callback();break}}this.menuOpened=!1,t="draw"}else e.pageX<50&&e.pageY<50?(this.drawMenu(),t=null):t="next";else t="draw",this.engine.firstPassed=!0;return t},Nauper.UI.prototype.move=function(e){if("choice"===this.engine.element.type){for(var t=e.pageX,i=e.pageY,n=!1,h=0;h<this.engine.element.map.length;h+=1){var r={x:.025*this.engine.size.width,y:(.25*h+.025)*this.engine.size.height,height:.2*this.engine.size.height,width:.95*this.engine.size.width};if(t>=r.x&&t<=r.x+r.width&&i>=r.y&&i<=r.y+r.height){this.engine.element.active=h,n=!0;break}}n||(this.engine.element.active=void 0),this.engine.element.active!==this.lastActive&&(this.lastActive=this.engine.element.active,this.engine.element.draw(!1))}},Nauper.UI.prototype.addMenuScreen=function(e){this.menu.push(e)},Nauper.UI.prototype.setMenuStyle=function(e){var t={mainbox:"default",maincolor:"#fff",smallbox:"default",smallcolor:"#eee",smallheight:.1,smallspace:.025,title:"#000",items:"#111"};this.menuStyle=putDefaults(t,e)},Nauper.UI.prototype.drawMenu=function(){var e=this,t=this.menu[this.currentMS].length,i=this.menuStyle.smallheight,n=this.menuStyle.smallspace,h={x:.125,height:(i+n)*t+n,width:.75};h.y=(1-h.height)/2,this.render.fillStyle="rgba(0, 0, 0, 0.7)",this.render.fillRect(0,0,this.engine.size.width,this.engine.size.height),this.drawTextBox({type:this.menuStyle.mainbox,color:this.menuStyle.maincolor,x:h.x,y:h.y,width:h.width,height:h.height,callback:function(){e.menu[e.currentMS].forEach(function(t,r){var s=h.y+r*(i+n)+n,a=h.width-2*n;e.menu[e.currentMS][r].x=(h.x+n)*e.size.width,e.menu[e.currentMS][r].y=s*e.size.height,e.menu[e.currentMS][r].width=a*e.size.width,e.menu[e.currentMS][r].height=e.menuStyle.smallheight*e.size.height,e.drawTextBox({type:e.menuStyle.smallbox,color:e.menuStyle.smallcolor,x:h.x+n,y:s,height:e.menuStyle.smallheight,width:a,callback:function(){var i=getTextHeight(e.engine.font)/e.size.height,h=s+e.menuStyle.smallheight/2-i/2+n;e.drawText({align:"center",color:e.menuStyle.items,y:h,text:t.text})}})})}}),this.menuOpened=!0},Nauper.UI.prototype.setMenuIconStyle=function(e){var t={type:"default",x:0,y:0,width:.05,height:.05,radius:.01,link:"",color:"#efefef"};this.menuIconStyle=putDefaults(t,e)},Nauper.UI.prototype.drawMenuIcon=function(){this.drawTextBox(this.menuIconStyle)};
"use strict";Nauper.Sound=function(t){this.engine=t,this.audio=this.engine.audio,this.repeating=!1,this.repeatend=function(){this.audio.play(),this.repeating=!0}.bind(this),this.stopend=function e(){this.stop(),this.audio.removeEventListener("ended",e)}.bind(this)},Nauper.Sound.prototype.play=function(t,e){this.audio.src="./data/sounds/"+t,this.audio.play(),e?this.audio.addEventListener("ended",this.stopend):e||this.audio.addEventListener("ended",this.repeatend)},Nauper.Sound.prototype.init=function(){this.setVolume()},Nauper.Sound.prototype.setVolume=function(t){"number"==typeof t&&t<=1&&(this.engine.audioVolume=t),this.volume=this.engine.audioVolume,this.audio.volume=this.volume},Nauper.Sound.prototype.pause=function(){this.audio.pause()},Nauper.Sound.prototype.stop=function(){this.pause(),this.repeating&&(this.audio.removeEventListener("ended",this.repeatend),this.repeating=!1),this.audio.src=""},Nauper.Sound.prototype.process=function(t,e){var i="/data/sounds/"+t,n=this.audio.src.substr(-i.length,i.length);void 0!==t&&i!==n&&(this.stop(),t&&this.play(t,e))};
"use strict";Nauper.Engine=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];this.font=e.font,this.audio=document.getElementById("audio"),this.canvas=document.getElementById("canvas"),this.render=this.canvas.getContext("2d"),this.size=getWindowSize(),this.ui=new Nauper.UI(this),this.sound=new Nauper.Sound(this),this.audioVolume=.1,this.canvas.width=this.size.width,this.canvas.height=this.size.height,this.render.font=this.font,this.firstPassed=!1,this.element=null,this.elements=t,this.globalIndex=0,this.localIndex=0,this.clickType=null,this.elementProcessor=function(e){var t=this.ui.process(e);"redraw"===t?this.element.draw():"next"===t?(this.click(e),this.sound.process(this.element.audio,this.element.once)):"draw"===t&&(this.element.draw(),this.sound.process(this.element.audio,this.element.once)),this.ui.drawMenuIcon()}.bind(this),this.resize=function(){this.size=getWindowSize(),this.ui.size=this.size,this.canvas.width=this.size.width,this.canvas.height=this.size.height,this.element.draw()}.bind(this),this.canvas.addEventListener("click",this.elementProcessor,!1),window.addEventListener("resize",this.resize,!1),window.addEventListener("mousemove",this.ui.move,!1)},Nauper.Engine.prototype.click=function(e){this.clickType&&this[this.clickType].call(this,e)},Nauper.Engine.prototype.choice=function(e){var t=this,i=e.pageX,s=e.pageY;this.element.map.forEach(function(e,n){var h={x:.025*t.size.width,y:(.25*n+.025)*t.size.height,height:.2*t.size.height,width:.95*t.size.width};i>=h.x&&i<=h.x+h.width&&s>=h.y&&s<=h.y+h.height&&(e.address!==!1&&(t.globalIndex=e.address,t.localIndex=-1),t.nextElement())})},Nauper.Engine.prototype.nextElement=function(){this.localIndex=Number(this.localIndex)+1,this.localIndex===this.elements[this.globalIndex].length?this.clickType=null:(this.element=this.elements[this.globalIndex][this.localIndex],this.element.draw.call(null,this),"choice"===this.element.type&&(this.element.necessary||void 0===this.element.necessary)?this.clickType="choice":this.clickType="nextElement")},Nauper.Engine.prototype.start=function(){return this.sound.init(),"frame"===this.elements[0][0].type?this.clickType="nextElement":"choice"===this.elements[0][0].type&&(this.clickType="choice"),this.element=this.elements[0][0],this.elementProcessor({pageX:-1,pageY:-1}),!0},Nauper.Engine.prototype.addScene=function(e){this.elements.push(e)};
"use strict";Nauper.Frame=function(t,e){this.engine=t,this.render=this.engine.render,this.size=this.engine.size,this.canvas=this.engine.canvas,this.characters=e.characters,this.displayOrder=e.displayOrder,this.background=e.background,this.text=e.textbox,this.audio=e.audio,this.once=e.once,this.type="frame",this.draw=function(){this.check()?(this.render.clearRect(0,0,this.size.width,this.size.height),this.engine.ui.setBackground(this.background),this.displayCharacters()):this.engine.nextElement()}.bind(this)},Nauper.Frame.prototype.check=function(){return!0},Nauper.Frame.prototype.setText=function(){var t=this;void 0!==this.text&&this.engine.ui.drawTextBox({type:this.text.type,color:this.text.background,link:this.text.link,callback:function(){t.engine.ui.drawText({text:t.text.name,color:t.text.ncl,x:.1,y:.83}),t.engine.ui.drawText({text:t.text.text,color:t.text.color,x:.1,y:.86})}})},Nauper.Frame.prototype.displayCharacters=function(){var t=this;void 0!==this.displayOrder&&0!==this.displayOrder.length?!function(){for(var e=t.displayOrder.length,i=function(i){var r=t.displayOrder[i];r!==!1&&void 0!==r?!function(){var n=new Image;n.onload=function(){var r=1.2*t.size.height/n.height,s=.1*t.size.height,a=t.size.width*(.225*i);t.render.drawImage(n,a,s,n.width*r,n.height*r),e-=1,0===e&&t.setText()},n.src=t.characters[r]}():e-=1},r=0;r<t.displayOrder.length;r+=1)i(r)}():this.setText()};
"use strict";Nauper.Question=function(i,t){this.background=t.background,this.activebox=t.textbox.active,this.inactivebox=t.textbox.inactive,this.boxtype=t.textbox.type,this.boxlink=t.textbox.link,this.type="choice",this.necessary=t.necessary,this.engine=i,this.render=this.engine.render,this.canvas=this.engine.canvas,this.size=this.engine.size,this.map=t.map,this.audio=t.audio,this.once=t.once,this.active=void 0,this.draw=function(){var i=this,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(0!==this.map.length&&this.map.length<=4){var e=.025,n=.2,s=.95,a=.05;t&&this.render.clearRect(0,0,this.size.width,this.size.height),this.engine.ui.setBackground(this.background);for(var h=function(t){void 0!==i.active&&i.active!==t||!function(){var h=i.map[t],o=void 0;o=i.active===t?i.activebox:i.inactivebox,i.engine.ui.drawTextBox({type:i.boxtype,color:o.background,link:i.boxlink,y:.25*t+.025,x:e,height:n,width:s,radius:a,callback:function(){i.engine.ui.drawText({text:h.text,align:"center",color:o.text,y:.25*t+.125})}})}()},o=0;o<this.map.length;o+=1)h(o)}else this.engine.nextElement()}.bind(this)};
"use strict";Nauper.Character=function(r){var t={};return r.emotions.forEach(function(n){t[n]=r.path+"/"+n+".png"}),t};