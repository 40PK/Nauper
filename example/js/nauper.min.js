var CANVAS=document.getElementsByTagName("canvas")[0];CANVAS.width=CANVAS.width||800,CANVAS.height=CANVAS.height||600;var TITLE="Nauper",RESIZE={width:CANVAS.width,height:CANVAS.height},RENDER=CANVAS.getContext("2d"),SCENE=-1,DIALOGS=[],HEROES=[],COVER=new Image;COVER.src="http://localhost:8000/data/backgrounds/1.jpg";
function Engine(t){t=t||{},RESIZE.width=t.width||RESIZE.width,RESIZE.height=t.height||RESIZE.height,TITLE=t.title||TITLE}Engine.prototype.setSize=function(t,e){return RESIZE.width=t,RESIZE.height=e,this},Engine.prototype.setTitle=function(t){return TITLE=t,this},Engine.prototype.setDialogs=function(t){DIALOGS=t},Engine.prototype.nextScene=function(){if(RENDER.clearRect(0,0,this.width,this.height),SCENE>DIALOGS.length-1&&(SCENE=-1),SCENE<0)RENDER.drawImage(COVER,0,0,this.width,this.height),RENDER.font="23px verdana",RENDER.fillStyle="black",RENDER.fillText(TITLE,50,100);else{var t=DIALOGS[SCENE];if(RENDER.drawImage(t.background,0,0,this.width,this.height),t.heroes.length>0){var e;for(e=0;e<t.heroes.length;e++){var E=t.heroes[e].split(":");E[0]=+E[0],RENDER.drawImage(HEROES[E[0]].emotion[E[1]],HEROES[E[0]].position.x,HEROES[E[0]].position.y,HEROES[E[0]].size.width,HEROES[E[0]].size.height)}}"dialog"===t.type&&(RENDER.fillStyle="white",RENDER.fillRect(30,this.height-150,this.width-60,140),RENDER.font="16px verdana",RENDER.fillStyle="black",t.author>=0?(RENDER.fillText(HEROES[t.author].name+":",50,this.height-125),wrapText(RENDER,t.text,50,this.height-100,this.width-100,20)):RENDER.fillText(t.text,50,this.height-125))}SCENE+=1},Engine.prototype.run=function(){document.getElementsByTagName("title")[0].innerHTML=TITLE,CANVAS.width=RESIZE.width,CANVAS.height=RESIZE.height,RENDER.font="18px verdana",RENDER.fillText("Nauper Engine",50,RESIZE.height-50),CANVAS.addEventListener("click",this.nextScene)};
function DialogsSystem(t){t=t||[],this.map=t}function DialogSystem(t){t=t||{},t.type=t.type||"dialog",t.heroes=t.heroes||[],this.map=t}DialogsSystem.prototype.add=function(t){return this.map.push(t.map),this},DialogsSystem.prototype.get=function(t){return t=+t||0,this.map[t]},DialogsSystem.prototype.getLength=function(){return this.map.length-1},DialogSystem.prototype.setText=function(t){return this.map.text=t,this},DialogSystem.prototype.setAuthor=function(t){return this.map.author=t,this},DialogSystem.prototype.setBackground=function(t){return this.map.background=new Image,this.map.background.src=t,this},DialogSystem.prototype.setHeroes=function(t){return this.map.heroes=t,this},DialogSystem.prototype.addHero=function(t){return this.map.heroes.push(t),this};
function HeroesSystem(){}function HeroSystem(t){var t=t||{};this.map={name:t.name||"Nauper",position:{x:0,y:0},size:{width:50,height:120}}}function EmotionsSystem(){this.emotions={}}function EmotionSystem(){this.emotion=new Image}HeroesSystem.prototype.add=function(t){HEROES.push(t.map)},HeroesSystem.prototype.remove=function(t){delete HEROES[t]},HeroSystem.prototype.setName=function(t){return this.map.name=t,this},HeroSystem.prototype.setPosition=function(t,o){return this.map.position.x=t,this.map.position.y=o,this},HeroSystem.prototype.setSize=function(t,o){return t=t||50,o=o||120,this.map.size.width=t,this.map.size.height=o,this},HeroSystem.prototype.setEmotions=function(t){return this.map.emotion=t.emotions,this},HeroSystem.prototype.addEmotion=function(t){return this.map.emotion.push(t.emotion),this},HeroSystem.prototype.activeEmotion=function(t){return this.map.active=t,this},EmotionsSystem.prototype.add=function(t,o){return this.emotions[t]=o.emotion,this},EmotionsSystem.prototype.remove=function(t){return delete this.emotions[t],this},EmotionSystem.prototype.setImage=function(t){return this.emotion.src=t,this};
function wrapText(t,e,l,i,r,a){for(var f=e.split(" "),x="",T=0;T<f.length;T++){var n=x+f[T]+" ",h=t.measureText(n),o=h.width;o>r&&T>0?(t.fillText(x,l,i),x=f[T]+" ",i+=a):x=n}t.fillText(x,l,i)}