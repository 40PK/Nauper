"use strict";var Nauper={version:"0.1"};
"use strict";var __nativeST__=window.setTimeout,__nativeSI__=window.setInterval;window.setTimeout=function(t,n){var i=this,e=Array.prototype.slice.call(arguments,2);return __nativeST__(t instanceof Function?function(){t.apply(i,e)}:t,n)},window.setInterval=function(t,n){var i=this,e=Array.prototype.slice.call(arguments,2);return __nativeSI__(t instanceof Function?function(){t.apply(i,e)}:t,n)};
"use strict";var getTextHeight=function(t){var e=document.createElement("p"),n=0;return e.style.font=t,e.style.position="relative",e.style.zIndex="-1",e.innerHTML="Test",document.body.appendChild(e),n=e.offsetHeight,document.body.removeChild(e),n},wrapText=function(t,e,n,r){var u=e.split(" "),i="",s=getTextHeight(n),o=0,a=[];return u.forEach(function(e,n){o=""===i?t.measureText(e).width:t.measureText(i+" "+e).width,o>r?(a.push(i),i=e):o===r?(a.push(i+" "+e),i=""):o<r&&(i=i?i+" "+e:e,n+1===u.length&&a.push(i))}),{result:a,height:s}},getTextOffset=function(t,e,n){var r=t.measureText(n).width,u=.5*e.width,i=.5*r,s=u-i;return s},putDefaults=function(t,e){var n=Object.getOwnPropertyNames(t),r={};return n.forEach(function(n){void 0===e[n]?r[n]=t[n]:void 0!==e[n]&&(r[n]=e[n])}),r},copyObject=function(t){var e={};return e=putDefaults(t,{})},getWindowSize=function(){var t={width:document.documentElement.clientWidth,height:document.documentElement.clientHeight};return t.coff=t.width/t.height,t},convertHexIntoRGBA=function(t,e){var n=t.replace("#",""),r={};return 3===n.length?(r.r=parseInt(n.substring(0,1),16),r.g=parseInt(n.substring(1,2),16),r.b=parseInt(n.substring(2,3),16)):6===n.length&&(r.r=parseInt(n.substring(0,2),16),r.g=parseInt(n.substring(2,4),16),r.b=parseInt(n.substring(4,6),16)),"rgba("+r.r+", "+r.g+", "+r.b+", "+e+")"},makeRequest=function(t,e){var n=new XMLHttpRequest;n.open("GET",t,!0),n.addEventListener("readystatechange",function(){e(n)}),n.send()},makeRequestSync=function(t,e){var n=new XMLHttpRequest;n.open("GET",t,!1),n.send(),e(n)};
"use strict";Nauper.UI=function(e){this.engine=e,this.canvas=this.engine.canvas,this.render=this.engine.render,this.size=this.engine.size,this.menu=[],this.menuStyle={},this.currentMS=0,this.lastActive=void 0,this.menuOpened=!1,this.menuIconStyle={},this.animationTimeouts=[],this.drawTextLine=function t(e,i,n,h){var s=0;if(h<e.length){s=this.render.measureText(e.substring(0,h)).width,this.render.fillText(e[h],i+s,n);var r=setTimeout.apply(this,[t,this.engine.textDelay,e,i,n,h+1]);this.animationTimeouts.push(r)}}.bind(this)},Nauper.UI.prototype.setBackground=function(e){e&&(this.canvas.style.backgroundImage="url(./data/images/backgrounds/"+e+")")},Nauper.UI.prototype.clearTimeouts=function(){for(var e=0;e<this.animationTimeouts.length;e+=1){var t=this.animationTimeouts[e];clearTimeout(t)}this.animationTimeouts=[]},Nauper.UI.prototype.drawTextBox=function(e){var t=this,i={type:"default",color:"#fff",link:"",x:.025,y:.8,height:.18,width:.95,radius:.05,callback:function(){}},n=putDefaults(i,e),h=this.size.width*n.x,s=this.size.height*n.y,r=this.size.height*n.height,a=this.size.width*n.width,l=this.size.height*n.radius;this.render.fillStyle=n.color,"default"===n.type?this.render.fillRect(h,s,a,r):"rounded"===n.type?(this.render.beginPath(),this.render.moveTo(h,s+l),this.render.lineTo(h,s+r-l),this.render.quadraticCurveTo(h,s+r,h+l,s+r),this.render.lineTo(h+a-l,s+r),this.render.quadraticCurveTo(h+a,s+r,h+a,s+r-l),this.render.lineTo(h+a,s+l),this.render.quadraticCurveTo(h+a,s,h+a-l,s),this.render.lineTo(h+l,s),this.render.quadraticCurveTo(h,s,h,s+l),this.render.fill()):"image"===n.type&&!function(){var e=new Image;e.addEventListener("load",function(i){t.render.drawImage(e,h,s,a,r),n.callback&&n.callback(i)}),e.src=n.link}(),"image"!==n.type&&n.callback()},Nauper.UI.prototype.drawText=function(e){var t=this,i={text:"",align:"wrapped",color:"#000",animation:!1,x:.1,y:.85,width:.8},n=putDefaults(i,e),h=this.size.width*n.x,s=this.size.height*n.y,r=this.size.width*n.width;if(this.render.fillStyle=n.color,"wrapped"===n.align)!function(){var e=wrapText(t.render,n.text,t.render.font,r);e.result.forEach(function(i,r){n.animation?t.drawTextLine(i,h,s+e.height*r,0):t.render.fillText(i,h,s+e.height*r)})}();else if("center"===n.align){var a=getTextOffset(this.render,{width:this.canvas.width},n.text);n.animation?this.drawTextLine(n.text,a,s,0):this.render.fillText(n.text,a,s)}},Nauper.UI.prototype.checkMenuIconClick=function(e){var t=this.menuIconStyle.x*this.engine.size.width,i=this.menuIconStyle.y*this.engine.size.width,n=this.menuIconStyle.width*this.engine.size.width,h=this.menuIconStyle.height*this.engine.size.width;return e.pageX>=t&&e.pageY>=i&&e.pageX<=t+n&&e.pageY<=i+h},Nauper.UI.prototype.process=function(e){var t=void 0,i=this.engine.elements[0][0];if(i!==this.engine.element||this.engine.firstPassed)if(this.menuOpened){for(var n=!1,h=0;h<this.menu[this.currentMS].length;h+=1){var s=this.menu[this.currentMS][h];if(e.pageX>=s.x&&e.pageX<=s.x+s.width&&e.pageY>=s.y&&e.pageY<=s.y+s.height){s.callback(),s.noclose&&(n=!0);break}}n?t=null:(this.menuOpened=!1,this.currentMS=0,t="draw")}else this.checkMenuIconClick(e)?(this.drawMenu(),t=null):t="next";else t="draw",this.engine.firstPassed=!0;return t},Nauper.UI.prototype.move=function(e){if("choice"===this.engine.element.type&&this.engine.ui.menuOpened===!1){for(var t=e.pageX,i=e.pageY,n=!1,h=0;h<this.engine.element.map.length;h+=1){var s={x:.025*this.engine.size.width,y:(.25*h+.025)*this.engine.size.height,height:.2*this.engine.size.height,width:.95*this.engine.size.width};if(t>=s.x&&t<=s.x+s.width&&i>=s.y&&i<=s.y+s.height){h!==this.engine.element.act&&(this.engine.element.drawQuestionBox(this.engine.element.act),this.engine.element.act=h,this.engine.element.drawQuestionBox(h,this.engine.element.activebox)),n=!0;break}}n||this.engine.element.drawQuestionBox(this.engine.element.act),this.drawMenuIcon()}},Nauper.UI.prototype.addMenuScreen=function(e){this.menu.push(e)},Nauper.UI.prototype.setMenuStyle=function(e){var t={mainbox:"default",maincolor:"#fff",smallbox:"default",smallcolor:"#eee",smallheight:.1,smallspace:.025,title:"#000",items:"#111"};this.menuStyle=putDefaults(t,e)},Nauper.UI.prototype.drawMenu=function(){var e=this,t=this.menu[this.currentMS].length,i=this.menuStyle.smallheight,n=this.menuStyle.smallspace,h={x:.125,height:(i+n)*t+n,width:.75};h.y=(1-h.height)/2,this.clearTimeouts(),this.render.clearRect(0,0,this.engine.size.width,this.engine.size.height),this.render.fillStyle="rgba(0, 0, 0, 0.7)",this.render.fillRect(0,0,this.engine.size.width,this.engine.size.height),this.drawTextBox({type:this.menuStyle.mainbox,color:this.menuStyle.maincolor,x:h.x,y:h.y,width:h.width,height:h.height,callback:function(){e.menu[e.currentMS].forEach(function(t,s){var r=h.y+s*(i+n)+n,a=h.width-2*n;e.menu[e.currentMS][s].x=(h.x+n)*e.size.width,e.menu[e.currentMS][s].y=r*e.size.height,e.menu[e.currentMS][s].width=a*e.size.width,e.menu[e.currentMS][s].height=e.menuStyle.smallheight*e.size.height,e.drawTextBox({type:e.menuStyle.smallbox,color:e.menuStyle.smallcolor,x:h.x+n,y:r,height:e.menuStyle.smallheight,width:a,callback:function(){var i=getTextHeight(e.engine.font)/e.size.height,h=r+e.menuStyle.smallheight/2-i/2+n;e.drawText({align:"center",color:e.menuStyle.items,y:h,text:t.text})}})})}}),this.menuOpened=!0},Nauper.UI.prototype.setMenuIconStyle=function(e){var t={type:"default",x:0,y:0,width:.05,height:.05,radius:.01,link:"",color:"#efefef"},i=putDefaults(t,e);i.height*=this.engine.size.coff,i.y*=this.engine.size.coff,this.menuIconStyle=i},Nauper.UI.prototype.drawMenuIcon=function(){this.menuOpened||this.drawTextBox(this.menuIconStyle)};
"use strict";Nauper.Sound=function(t){this.engine=t,this.audio=this.engine.audio,this.repeating=!1,this.repeatend=function(){this.audio.play(),this.repeating=!0}.bind(this),this.stopend=function e(){this.stop(),this.audio.removeEventListener("ended",e)}.bind(this)},Nauper.Sound.prototype.play=function(t,e){this.audio.src="./data/sounds/"+t,this.audio.play(),e?this.audio.addEventListener("ended",this.stopend):e||this.audio.addEventListener("ended",this.repeatend)},Nauper.Sound.prototype.init=function(){this.setVolume()},Nauper.Sound.prototype.setVolume=function(t){"number"==typeof t&&t<=1&&t>=0&&(this.engine.audioVolume=t),this.volume=this.engine.audioVolume,this.audio.volume=this.volume},Nauper.Sound.prototype.pause=function(){this.audio.pause()},Nauper.Sound.prototype.stop=function(){this.pause(),this.repeating&&(this.audio.removeEventListener("ended",this.repeatend),this.repeating=!1),this.audio.src=""},Nauper.Sound.prototype.process=function(t,e){var i="/data/sounds/"+t,n=this.audio.src.substr(-i.length,i.length);void 0!==t&&i!==n&&(this.stop(),t&&this.play(t,e))};
"use strict";Nauper.Engine=function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];this.font=e.font,this.audio=document.getElementById("audio"),this.canvas=document.getElementById("canvas"),this.render=this.canvas.getContext("2d"),this.size=getWindowSize(),this.ui=new Nauper.UI(this),this.sound=new Nauper.Sound(this),this.audioVolume=.1,this.canvas.width=this.size.width,this.canvas.height=this.size.height,this.render.font=this.font,this.firstPassed=!1,this.element=null,this.textDelay=e.textInterval,this.elements=i,this.globalIndex=0,this.localIndex=0,this.clickType=null,this.elementProcessor=function(e){var t=this.ui.process(e);this.ui.clearTimeouts(),"redraw"===t?this.element.draw():"next"===t?(this.click(e),this.sound.process(this.element.audio,this.element.once)):"draw"===t&&(this.element.draw(),this.sound.process(this.element.audio,this.element.once)),this.ui.drawMenuIcon()}.bind(this),this.resize=function(){this.size=getWindowSize(),this.ui.size=this.size,this.canvas.width=this.size.width,this.canvas.height=this.size.height,this.element.draw()}.bind(this),this.canvas.addEventListener("click",this.elementProcessor,!1),window.addEventListener("resize",this.resize,!1),window.addEventListener("mousemove",function(e){t.ui.move(e)})},Nauper.Engine.prototype.click=function(e){this.clickType&&this[this.clickType].call(this,e)},Nauper.Engine.prototype.choice=function(e){var t=this,i=e.pageX,s=e.pageY;this.element.map.forEach(function(e,n){var h={x:.025*t.size.width,y:(.25*n+.025)*t.size.height,height:.2*t.size.height,width:.95*t.size.width};i>=h.x&&i<=h.x+h.width&&s>=h.y&&s<=h.y+h.height&&(e.address!==!1&&(t.globalIndex=e.address,t.localIndex=-1),t.element.active=void 0,t.nextElement())})},Nauper.Engine.prototype.nextElement=function(){this.localIndex=Number(this.localIndex)+1,this.localIndex===this.elements[this.globalIndex].length?this.clickType=null:(this.element=this.elements[this.globalIndex][this.localIndex],this.element.draw.call(null,this),"choice"===this.element.type&&(this.element.necessary||void 0===this.element.necessary)?this.clickType="choice":this.clickType="nextElement")},Nauper.Engine.prototype.start=function(){return this.sound.init(),"frame"===this.elements[0][0].type?this.clickType="nextElement":"choice"===this.elements[0][0].type&&(this.clickType="choice"),this.element=this.elements[0][0],this.elementProcessor({pageX:-1,pageY:-1}),!0},Nauper.Engine.prototype.addScene=function(e){this.elements.push(e)};
"use strict";Nauper.Frame=function(t,e){this.engine=t,this.render=this.engine.render,this.size=this.engine.size,this.canvas=this.engine.canvas,this.characters=e.characters,this.displayOrder=e.displayOrder,this.background=e.background,this.text=e.textbox,this.audio=e.audio,this.once=e.once,this.type="frame",this.textAnimation=e.textAnimation,this.loaded=0,this.draw=function(){this.render.clearRect(0,0,this.size.width,this.size.height),this.engine.ui.setBackground(this.background),this.displayCharacters()}.bind(this)},Nauper.Frame.prototype.setText=function(){var t=this;void 0!==this.text&&this.engine.ui.drawTextBox({type:this.text.type,color:this.text.background,link:this.text.link,callback:function(){t.engine.ui.drawText({text:t.text.name,color:t.text.ncl,x:.1,y:.83,animation:t.textAnimation}),t.engine.ui.drawText({text:t.text.text,color:t.text.color,x:.1,y:.86,animation:t.textAnimation})}})},Nauper.Frame.prototype.createImageDrawCallback=function(t,e){var i=this,a=function(){var a=1.2*i.size.height/t.height,r=.1*i.size.height,s=i.size.width*(.225*e);i.render.drawImage(t,s,r,t.width*a,t.height*a),i.loaded-=1,0===i.loaded&&i.setText()};return a},Nauper.Frame.prototype.displayCharacters=function(){if(void 0!==this.displayOrder&&0!==this.displayOrder.length){this.loaded=this.displayOrder.length;for(var t=0;t<this.displayOrder.length;t+=1){var e=this.displayOrder[t];if(e!==!1&&void 0!==e){var i=new Image;i.onload=this.createImageDrawCallback(i,t),i.src=this.characters[e]}else this.loaded-=1}}else this.setText()};
"use strict";Nauper.Question=function(i,t){this.background=t.background,this.activebox=t.textbox.active,this.inactivebox=t.textbox.inactive,this.boxtype=t.textbox.type,this.boxlink=t.textbox.link,this.type="choice",this.necessary=t.necessary,this.engine=i,this.render=this.engine.render,this.canvas=this.engine.canvas,this.size=this.engine.size,this.map=t.map,this.audio=t.audio,this.once=t.once,this.act=-1,this.box=this.inactivebox,this.coordmap={x:.025,height:.2,width:.95,radius:.05},this.draw=function(){if(0!==this.map.length&&this.map.length<=4){this.render.clearRect(0,0,this.engine.size.width,this.engine.size.height),this.engine.ui.setBackground(this.background);for(var i=0;i<this.map.length;i+=1)this.drawQuestionBox(i,this.inactivebox)}else this.engine.nextElement()}.bind(this),this.drawQuestionBox=function(i,t){var e=this,s=void 0;s=void 0===t?this.inactivebox:t,i!==-1&&this.engine.ui.drawTextBox({type:this.boxtype,color:s.background,link:this.boxlink,y:.25*i+.025,x:this.coordmap.x,height:this.coordmap.height,width:this.coordmap.width,radius:this.coordmap.radius,callback:function(){e.engine.ui.drawText({text:e.map[i].text,align:"center",color:s.text,y:.25*i+.125})}})}.bind(this)};
"use strict";Nauper.Redirect=function(e,n){var t={globalIndex:0,localIndex:0};this.engine=e,this.conf=putDefaults(t,n)},Nauper.Redirect.prototype.draw=function(){this.engine.globalIndex=this.conf.globalIndex,this.engine.localIndex=this.conf.localIndex-1,this.engine.nextElement()};
"use strict";Nauper.Character=function(r){var t={};return r.emotions.forEach(function(n){t[n]=r.path+"/"+n+".png"}),t};